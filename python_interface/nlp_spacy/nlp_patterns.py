# python_bot/nlp_patterns.py

# --- общие токены для переиспользования ---
PREP_IN_CITY = {"LOWER": {"IN": ["в", "для", "по", "о", "с", "на"]}, "OP": "?"} # Добавил "на" для "погода на сегодня"
CITY = {"ENT_TYPE": "CITY", "OP": "?"}
DATE = {"ENT_TYPE": "DATE"}
WEATHER = {"LEMMA": "погода"}
WEATHER_COND = {"ENT_TYPE": "WEATHER_CONDITION"} # Предполагается, что WEATHER_CONDITION_PATTERNS в config.py включает "дождь", "снег", "гроза", "солнце", "ясно", "облачно" и т.д.
TEMPERATURE = {"LEMMA": "температура"}
WIND = {"LEMMA": "ветер"}
TEMP_MODIFIER = {"LOWER": {"IN": ["выше", "больше", "ниже", "меньше", "около", "около"]}} # Уверен, что "около" не дублируется?
TIME_EXPRESSION = {"ENT_TYPE": "TIME"} # Для распознавания времени (e.g., "в 8 утра", "к 17:00")

# --- spaCy matcher patterns by intent ---
NLP_PATTERNS = {
    "/forecast": [
        # Самые длинные и специфичные паттерны для прогноза
        # "Прогноз погоды в [город] на [дата]"
        [{"LEMMA": "прогноз"}, WEATHER, PREP_IN_CITY, CITY, {"LOWER": "на", "OP": "?"}, DATE],
        # "Прогноз погоды в [город]" (на сегодня/ближайшее время по умолчанию)
        [{"LEMMA": "прогноз"}, WEATHER, PREP_IN_CITY, CITY],
        # "Прогноз погоды"
        [{"LEMMA": "прогноз"}, WEATHER],

        # Различные формулировки с "прогноз" и датой
        # "Прогноз на [дата] в [город]"
        [{"LEMMA": "прогноз"}, {"LOWER": "на", "OP": "?"}, DATE, PREP_IN_CITY, CITY, WEATHER, {"OP": "?"}],
        # "Какой прогноз на [дата] в [город]"
        [{"LEMMA": "какой"}, {"LEMMA": "прогноз"}, PREP_IN_CITY, CITY, {"LOWER": "на", "OP": "?"}, DATE],
        # "Прогноз в [город]"
        [{"LEMMA": "прогноз"}, PREP_IN_CITY, CITY],
        # "Прогноз на [дата]"
        [{"LEMMA": "прогноз"}, {"LOWER": "на", "OP": "?"}, DATE],

        # Запросы погоды на конкретную дату (подразумевают прогноз)
        # "Погода на [дата] в [город]"
        [WEATHER, {"LOWER": "на", "OP": "?"}, DATE, PREP_IN_CITY, CITY],
        # "[Дата] погода в [город]"
        [DATE, WEATHER, PREP_IN_CITY, CITY],
        # "[Дата] какая погода"
        [DATE, {"LEMMA": "какой"}, WEATHER],
        # "Что будет с погодой в [город] на [дата]"
        [{"LEMMA": {"IN": ["что", "как"]}}, WEATHER, {"LOWER": "будет", "OP": "?"}, PREP_IN_CITY, CITY, {"LOWER": "на", "OP": "?"}, DATE],
        # "Какая погода ожидается на [дата]"
        [{"LEMMA": "какой"}, WEATHER, {"LEMMA": "ожидать", "OP": "?"}, {"LOWER": "на", "OP": "?"}, DATE, PREP_IN_CITY, CITY, {"OP":"?"}], # Расширенный паттерн

        # Запросы о конкретных условиях на дату (подразумевают прогноз)
        # "Будет ли [условие] в [город] на [дата]?"
        [{"LEMMA": "быть"}, {"LOWER": "ли"}, WEATHER_COND, PREP_IN_CITY, CITY, {"LOWER": "на", "OP": "?"}, DATE],
        # "Будет ли [условие] на [дата]?"
        [{"LEMMA": "быть"}, {"LOWER": "ли"}, WEATHER_COND, {"LOWER": "на", "OP": "?"}, DATE],
        # "Ожидается ли [условие] в [город] на [дата]?"
        [{"LEMMA": "ожидать"}, {"LOWER": "ли", "OP": "?"}, WEATHER_COND, PREP_IN_CITY, CITY, {"LOWER": "на", "OP": "?"}, DATE],
        # "Будет ли солнце/дождь?" (на ближайший прогноз)
        [{"LEMMA": "быть"}, {"LOWER": "ли"}, {"LOWER": {"IN": ["солнце", "дождь", "снег"]}}],
    ],

    "/weather": [
        # Общие запросы текущей погоды - фокус на "сейчас" или общие без даты/прогноза
        # "Погода [сейчас] в [город]"
        [WEATHER, {"LOWER": "сейчас", "OP": "?"}, PREP_IN_CITY, CITY],
        # "Какая погода в [город] [сейчас]"
        [{"LEMMA": "какой"}, WEATHER, PREP_IN_CITY, CITY, {"LOWER": "сейчас", "OP": "?"}],
        # "Что/как там погода в [город]"
        [{"LEMMA": {"IN": ["что", "как"]}}, {"LOWER": "там", "OP": "?"}, WEATHER, PREP_IN_CITY, CITY],
        # "Показать погоду в [город]"
        [{"LEMMA": "показать"}, WEATHER, PREP_IN_CITY, CITY],
        # "[Город] погода [сейчас]"
        [CITY, WEATHER, {"LOWER": "сейчас", "OP": "?"}],
        # "Какая сейчас погода?"
        [{"LEMMA": "какой"}, {"LOWER": "сейчас", "OP": "?"}, WEATHER],
        # "Расскажи о погоде"
        [{"LEMMA": "рассказать"}, {"LOWER": "о"}, WEATHER],

        # Запросы температуры
        # "Температура в [город]"
        [TEMPERATURE, PREP_IN_CITY, CITY],
        # "Сколько/какая температура в [город]"
        [{"LEMMA": {"IN": ["сколько", "какая"]}}, TEMPERATURE, PREP_IN_CITY, CITY],
        # "[Город] температура"
        [CITY, TEMPERATURE],
        # "Какая температура [сейчас]?"
        [{"LEMMA": "какой"}, {"LOWER": "сейчас", "OP": "?"}, TEMPERATURE],

        # Запросы ветра
        # "Какой ветер в [город]"
        [{"LEMMA": "какой"}, WIND, PREP_IN_CITY, CITY],
        # "Ветер в [город]"
        [WIND, PREP_IN_CITY, CITY],
        # "Сильный ветер в [город]"
        [{"LEMMA": "сильный", "OP": "?"}, WIND, PREP_IN_CITY, CITY],
        # "Скорость ветра в [город]"
        [{"LEMMA": "скорость"}, WIND, PREP_IN_CITY, CITY],
        # "Какой ветер [сейчас]?"
        [{"LEMMA": "какой"}, {"LOWER": "сейчас", "OP": "?"}, WIND],
    ],

    "/subscribe": [
        # Более разговорные и полные фразы для подписки
        # "Подпиши меня на [город] если будет [дождь/снег/гроза]"
        [{"LOWER": {"IN": ["подпиши", "подпишите"]}}, {"LOWER": "меня", "OP": "?"}, {"LOWER": "на"}, CITY, {"LOWER": "если"}, {"LOWER": "будет"}, WEATHER_COND],
        # "Подпиши меня на [город] при [дожде/снеге/грозе]"
        [{"LOWER": {"IN": ["подпиши", "подпишите"]}}, {"LOWER": "меня", "OP": "?"}, {"LOWER": "на"}, CITY, {"LOWER": "при"}, WEATHER_COND],
        # "Подпиши меня на [город] если температура [выше/ниже] X"
        [{"LOWER": {"IN": ["подпиши", "подпишите"]}}, {"LOWER": "меня", "OP": "?"}, {"LOWER": "на"}, CITY, {"LOWER": "если"}, TEMPERATURE, TEMP_MODIFIER, {"LIKE_NUM": True}],
        # "Подпиши меня на [город] если ветер [больше/меньше] X"
        [{"LOWER": {"IN": ["подпиши", "подпишите"]}}, {"LOWER": "меня", "OP": "?"}, {"LOWER": "на"}, CITY, {"LOWER": "если"}, WIND, TEMP_MODIFIER, {"LIKE_NUM": True}],
        # "Подпиши на [город]" (общая подписка, если нет других условий)
        [{"LOWER": {"IN": ["подпиши", "подпишите"]}}, {"LOWER": "меня", "OP": "?"}, {"LOWER": "на"}, CITY],

        # Более формальные/стандартные паттерны с леммами
        # "Подписаться на [условие] в [город]"
        [{"LEMMA": {"IN": ["подписать", "подписаться"]}}, {"LOWER": "меня", "OP": "?"}, {"LOWER": "на"}, WEATHER_COND, PREP_IN_CITY, CITY],
        # "Хочу/нужно уведомление о [условие] в [город]"
        [{"LEMMA": {"IN": ["хотеть", "нужно"]}}, {"LEMMA": "уведомление"}, {"LOWER": {"IN": ["о", "про", "на"]}, "OP": "?"}, WEATHER_COND, PREP_IN_CITY, CITY],
        # "Создать/добавить подписку на [условие] в [город]"
        [{"LEMMA": {"IN": ["создавать", "добавить"]}}, {"LEMMA": "подписка"}, PREP_IN_CITY, CITY, {"LOWER": "на"}, WEATHER_COND],

        # Паттерны для подписки по температуре и ветру с леммами
        # "Подписаться на температуру [выше/ниже] X в [город]"
        [{"LEMMA": {"IN": ["подписать", "подписаться"]}}, {"LOWER": "на"}, TEMPERATURE, TEMP_MODIFIER, {"LIKE_NUM": True}, PREP_IN_CITY, CITY],
        # "Подписаться на ветер [больше/меньше] X в [город]"
        [{"LEMMA": {"IN": ["подписать", "подписаться"]}}, {"LOWER": "на"}, WIND, TEMP_MODIFIER, {"LIKE_NUM": True}, PREP_IN_CITY, CITY],

        # Уведомления и время
        # "Уведомлять меня о [условие] в [город]"
        [{"LEMMA": "уведомлять"}, {"LOWER": "меня", "OP": "?"}, {"LOWER": {"IN": ["о", "про"]}, "OP": "?"}, WEATHER_COND, PREP_IN_CITY, CITY],
        # "Уведомление о [условие] в [город]"
        [{"LEMMA": "уведомление"}, {"LOWER": "о"}, WEATHER_COND, PREP_IN_CITY, CITY],
        # "Уведомлять меня в [время] в [город]"
        [{"LEMMA": "уведомлять"}, {"LOWER": "меня", "OP": "?"}, {"LOWER": "в"}, TIME_EXPRESSION, PREP_IN_CITY, CITY]
    ],

    "/unsubscribe": [
        # Расширенные паттерны для отписки
        # "Отпиши меня от [условие] в [город]"
        [{"LOWER": {"IN": ["отпиши", "отпишите"]}}, {"LOWER": "меня", "OP": "?"}, {"LOWER": "от"}, WEATHER_COND, PREP_IN_CITY, CITY],
        # "Отпиши меня от [город]" (от всех подписок в городе)
        [{"LOWER": {"IN": ["отпиши", "отпишите"]}}, {"LOWER": "меня", "OP": "?"}, {"LOWER": "от"}, CITY],
        # "Отменить подписку на [город]"
        [{"LEMMA": {"IN": ["отменить", "удалить"]}}, {"LEMMA": "подписка"}, {"LOWER": "на"}, CITY],
        # "Отменить уведомления о [условие] в [город]"
        [{"LEMMA": {"IN": ["отменить", "удалить"]}}, {"LEMMA": "уведомление"}, {"LOWER": {"IN": ["о", "про"]}, "OP": "?"}, WEATHER_COND, PREP_IN_CITY, CITY],
        # "Убрать подписку на [условие] в [город]"
        [{"LEMMA": {"IN": ["убрать", "отписать"]}}, {"LEMMA": "подписка"}, {"LOWER": "на"}, WEATHER_COND, PREP_IN_CITY, CITY],
        # "Отменить подписку на температуру [выше/ниже] X в [город]"
        [{"LEMMA": {"IN": ["отменить", "удалить"]}}, {"LEMMA": "подписка"}, {"LOWER": "на", "OP": "?"}, CITY, TEMPERATURE, TEMP_MODIFIER, {"LIKE_NUM": True}],
        # "Отменить подписку на ветер [больше/меньше] X в [город]"
        [{"LEMMA": {"IN": ["отменить", "удалить"]}}, {"LEMMA": "подписка"}, {"LOWER": "на", "OP": "?"}, CITY, WIND, TEMP_MODIFIER, {"LIKE_NUM": True}],
    ],

    "/mycity": [
        # Расширенные паттерны для установки/проверки своего города
        # "Установить/поставить/сделать [мой/свой] город [по умолчанию/основным/главным] [город]"
        [{"LEMMA": {"IN": ["установить", "поставить", "сделать", "изменить", "сменить"]}}, {"LOWER": {"IN": ["мой", "свой"]}, "OP": "?"}, {"LEMMA": "город"}, {"LOWER": {"IN": ["по умолчанию", "основным", "главным"]}, "OP": "?"}, CITY],
        # "Установить/поставить [город/место] по умолчанию [город]"
        [{"LEMMA": {"IN": ["установить", "поставить"]}}, {"LOWER": {"IN": ["город", "место"]}}, {"LOWER": {"IN": ["по умолчанию", "основной"]}}, CITY],
        # "Мой город [город]" / "Город по умолчанию [город]"
        [{"LEMMA": "город"}, {"LOWER": {"IN": ["по умолчанию", "мой", "основной"]}}, CITY],
        # "Какой мой город?"
        [{"LEMMA": {"IN": ["показать", "какой"]}}, {"LOWER": "мой"}, {"LEMMA": "город"}],
        # "Покажи город по умолчанию"
        [{"LEMMA": "показать"}, {"LEMMA": "город"}, {"LOWER": {"IN": ["по умолчанию", "основной"]}}]
    ],

    "/start": [
        [{"TEXT": "/start"}],
        [{"LEMMA": "старт"}],
        [{"LEMMA": "начать"}],
        [{"LOWER": "привет"}], # Простое приветствие
        [{"LOWER": "здравствуйте"}]
    ],

    "/help": [
        [{"TEXT": "/help"}],
        [{"LEMMA": "помощь"}],
        [{"LOWER": "что"}, {"LOWER": "ты"}, {"LEMMA": "уметь", "OP": "?"}], # "Что ты умеешь?"
        [{"LEMMA": "помогать"}]
    ],

    "/list_subscriptions": [
        [{"LEMMA": "мои"}, {"LEMMA": "подписка"}],
        [{"LEMMA": "список"}, {"LEMMA": "подписка"}],
        [{"LOWER": "показать"}, {"LOWER": "мои"}, {"LEMMA": "подписка"}],
        [{"LOWER": "какие"}, {"LOWER": "у"}, {"LOWER": "меня"}, {"LEMMA": "подписка"}]
    ],

    "/track": [ # Отслеживание каких-либо событий или состояний
        [{"LEMMA": "отследить"}],
        [{"LEMMA": "трек"}],
        [{"LEMMA": "отслеживать"}],
        [{"LEMMA": "добавить"}, {"LEMMA": "отслеживание"}],
        [{"LOWER": "следить"}, {"LOWER": "за"}, {"LEMMA": "погода", "OP": "?"}, PREP_IN_CITY, CITY]
    ],

    "/untrack": [ # Отмена отслеживания
        [{"LEMMA": "отменить"}, {"LEMMA": "отслеживание"}],
        [{"LEMMA": "удалить"}, {"LEMMA": "трек"}],
        [{"LEMMA": "убрать"}, {"LEMMA": "отслеживание"}],
        [{"LOWER": "перестать"}, {"LOWER": "следить"}, {"LOWER": "за"}, {"LEMMA": "погода", "OP": "?"}, PREP_IN_CITY, CITY]
    ],

    "/list_tracks": [ # Список отслеживаемых событий
        [{"LEMMA": "мои"}, {"LEMMA": "отслеживание"}],
        [{"LEMMA": "список"}, {"LEMMA": "отслеживание"}],
        [{"LOWER": "показать"}, {"LOWER": "мои"}, {"LEMMA": "отслеживание"}],
        [{"LOWER": "что"}, {"LOWER": "я"}, {"LEMMA": "отслеживать", "OP": "?"}],
        [{"LOWER": "за"}, {"LOWER": "чем"}, {"LOWER": "я"}, {"LEMMA": "следить"}]
    ]
}